// --------------------------------------------------------------------------------
// |                        Firestore Security Rules                          |
// --------------------------------------------------------------------------------
// To deploy these rules, you would typically place them in a `firestore.rules`
// file and run `firebase deploy --only firestore:rules`.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requesting user is an admin
    function isAdmin() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
 
    // Rules for the results collection
    match /results/{resultId} {
      allow read: if true; // Allow public read access to results
      allow write: if isAdmin(); // Only admins can write new results
    }
    
    // Rules for the users collection
    match /users/{userId} {
     allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || resource.data.referredBy == request.auth.uid);
     allow update: if request.auth != null && request.auth.uid == userId && 
                          (!('role' in request.resource.data) || request.resource.data.role ==
        resource.data.role);
      allow delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // --- START: RULES FOR 1-12 WIN GAME ---
    
    match /game_state/{docId} {
         allow read, write: if request.auth != null;
    }
    
    match /wingame_bets/{betId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if request.auth != null;
    }
    
    match /wingame_rounds/{roundId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // --- END: RULES FOR 1-12 WIN GAME ---
    
    // Rules for the withdrawals collection
    match /withdrawals/{withdrawalId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }
    
    // Rules for top-up (deposit) requests
    match /top-ups/{topUpId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Rules for the 'winners' collection
    match /winners/{winnerId} {
      allow read: if request.auth != null && isAdmin();
      allow update: if isAdmin();
    }
  
    // Rules for the transactions collection (for referral bonuses, etc.)
    match /transactions/{transactionId} {
        allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Rules for marquee settings
    match /settings/marquee {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- START: RULES FOR CRYPTO ADMIN COMPONENTS ---

    // Rules for 'paymentMethods' collection (for AdminUpi and UsdtDeposit config)
    match /paymentMethods/{docId} {
      allow read: if request.auth != null; // All authenticated users can read payment methods
      allow write: if isAdmin();            // Only admins can modify payment methods
    }

    // Rules for 'depositRequests' collection (for DepositApproval)
    match /depositRequests/{depositId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow read, update: if isAdmin(); // Admins can read all and update status
    }

    // Rules for 'marketData' collection (for UsdtRates)
    match /marketData/{docId} {
      allow read: if request.auth != null; // All authenticated users can read market data
      allow write: if isAdmin();            // Only admins can modify market data
    }

    // --- END: RULES FOR CRYTO ADMIN COMPONENTS ---
    
    // DEPRECATED / Other Game Rules
    match /bets/{betId} {
       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;                    
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());  
    }
    match /harufBets/{betId} {
     allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
     allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
   }
     match /carousel_slides/{slideId} {                                                                              
             allow read: if true;                                                             
             allow write: if isAdmin();                                                    
             } 
     match /market_timings/{marketId} {                                                                         
      allow read: if true;                                                        
      allow write: if isAdmin();                                              
    }
       match /settings/jackpot {                                                                                       
     allow read: if true;                                                                                         
   allow write: if isAdmin();                                                                                   
 } 
       match /rouletteBets/{betId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}


// --------------------------------------------------------------------------------
// |                         Firebase Storage Security Rules                      |
// --------------------------------------------------------------------------------
// To deploy these rules, you would typically place them in a `storage.rules`
// file and run `firebase deploy --only storage:rules`.

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if the user is an admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- General Access Rules ---
    
    // Allow public read for carousel images and the single barcode
    match /carousel/{fileName} {
      allow read: if true;
    }
    match /barcodes/qr.jpg {
      allow read: if true;
    }

    // Allow authenticated users to read files that aren't public
    match /{allPaths=**} {
      allow read: if request.auth != null;
    }

    // --- User-Specific Write Rules ---
    
    // Allow any authenticated user to write to these paths
    match /carousel/{fileName} {
        allow write: if request.auth != null;
    }
    match /barcodes/qr.jpg {
       allow write: if request.auth != null;
    }
    match /paymentProofs/{userId}/{fileName} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Admin-Specific Write Rules ---

    // Only administrators can write to the 'qrcodes' folder (for AdminUpi)
    match /qrcodes/{fileName} {
      allow write: if isAdmin();
    }

    // Only administrators can write to the 'usdtdeposit' folder (for UsdtDeposit)
    match /usdtdeposit/{fileName} {
      allow write: if isAdmin();
    }
  }
}
